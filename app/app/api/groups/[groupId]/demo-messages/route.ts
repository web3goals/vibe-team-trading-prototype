import { createFailedApiResponse, createSuccessApiResponse } from "@/lib/api";
import { getErrorString } from "@/lib/error";
import {
  getMessageWithDistributeRequest,
  getMessageWithDistributeStatus,
  getMessageWithEntryTradeStatus,
  getMessageWithExitTradeStatus,
  getMessageWithStartTradeRequest,
  getMessageWithWithdrawRequest,
} from "@/lib/messages";
import { findGroups, insertOrUpdateGroup } from "@/mongodb/services/group";
import { GroupMessage } from "@/types/group";
import { NextRequest } from "next/server";
import z from "zod";

export async function POST(
  request: NextRequest,
  { params }: { params: Promise<{ groupId: string }> },
) {
  try {
    console.log("[API] Creating demo message...");

    const { groupId } = await params;

    // Define the schema for request body validation
    const bodySchema = z.object({
      category: z.enum([
        "start_trade_request",
        "withdraw_request",
        "entry_trade_status",
        "exit_trade_status",
        "distribute_request",
        "distribute_status",
      ]),
    });

    // Extract request body
    const body = await request.json();

    // Validate request body using schema
    const bodyParseResult = bodySchema.safeParse(body);
    if (!bodyParseResult.success) {
      return createFailedApiResponse(
        {
          message: `Invalid request body: ${bodyParseResult.error.issues
            .map((issue) => `${issue.path.join(".")}: ${issue.message}`)
            .join(", ")}`,
        },
        400,
      );
    }

    // Extract validated data
    const { category } = bodyParseResult.data;

    // Find the group
    const group = await findGroups({ id: groupId }).then((groups) => groups[0]);
    if (!group) {
      throw new Error(`Group not found with id: ${groupId}`);
    }

    // Create a message based on the category
    let message: GroupMessage | undefined;
    if (category === "start_trade_request") {
      const content = [
        "Agreed üíØ",
        "Technicals look primed for a bounce",
        "I propose buying ENS now and exiting once it clears the immediate $7.20 resistance",
        "To execute, sign the Yellow message to allocate 1 USDC each",
      ].join("\n\n");
      message = await getMessageWithStartTradeRequest(group, content);
    }
    if (category === "withdraw_request") {
      const content = [
        "Funds allocated ü§ù",
        "Now, please sign this Yellow message to authorize the withdrawal of the USDC to the execution wallet",
        "I will then route the swap through LI.FI to ensure the best execution price for our entry",
      ].join("\n\n");
      message = await getMessageWithWithdrawRequest(group, content);
    }
    if (category === "entry_trade_status") {
      const content = [
        "Trade executed üëå",
        "I've successfully swapped  2 USDC for 0.36 ENS via LI.FI",
        "I am now monitoring the price and will automatically trigger the sell once we hit our $7.20 target",
      ].join("\n\n");
      const extraLifiExecuteRouteResponse = `{"id":"ea7bbd39-9da7-4cdd-838c-708d5e1e5777","fromChainId":8453,"fromAmountUSD":"0.1000","fromAmount":"100000","fromToken":{"address":"0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913","chainId":8453,"symbol":"USDC","decimals":6,"name":"USD Coin","coinKey":"USDC","logoURI":"https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48/logo.png","priceUSD":"0.999914","tags":["stablecoin"]},"fromAddress":"0xB418506A0dd0E6c81B2a2901a8aa2B6F409BFB3f","toChainId":8453,"toAmountUSD":"0.0848","toAmount":"1187519783431776763904","toAmountMin":"1181582184514617880084","toToken":{"address":"0x9f86dB9fc6f7c9408e8Fda3Ff8ce4e78ac7a6b07","chainId":8453,"symbol":"CLAWD","decimals":18,"name":"clawd.atg.eth","priceUSD":"0.00007144","tags":[]},"toAddress":"0xB418506A0dd0E6c81B2a2901a8aa2B6F409BFB3f","gasCostUSD":"0.0025","containsSwitchChain":false,"steps":[{"type":"lifi","id":"ea7bbd39-9da7-4cdd-838c-708d5e1e5777:0","tool":"sushiswap","toolDetails":{"key":"sushiswap","name":"SushiSwap Aggregator","logoURI":"https://raw.githubusercontent.com/lifinance/types/main/src/assets/icons/exchanges/sushi.svg"},"action":{"fromToken":{"address":"0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913","chainId":8453,"symbol":"USDC","decimals":6,"name":"USD Coin","coinKey":"USDC","logoURI":"https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48/logo.png","priceUSD":"0.999914","tags":["stablecoin"]},"fromAmount":"100000","toToken":{"address":"0x9f86dB9fc6f7c9408e8Fda3Ff8ce4e78ac7a6b07","chainId":8453,"symbol":"CLAWD","decimals":18,"name":"clawd.atg.eth","priceUSD":"0.00007144","tags":[]},"fromChainId":8453,"toChainId":8453,"slippage":0.005,"fromAddress":"0xB418506A0dd0E6c81B2a2901a8aa2B6F409BFB3f","toAddress":"0xB418506A0dd0E6c81B2a2901a8aa2B6F409BFB3f"},"estimate":{"tool":"sushiswap","approvalAddress":"0x1231DEB6f5749EF6cE6943a275A1D3E7486F4EaE","toAmountMin":"1180449122777431252664","toAmount":"1186381027917016334336","fromAmount":"100000","feeCosts":[{"name":"LIFI Fixed Fee","description":"Fixed LIFI fee, independent of any other fee","token":{"address":"0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913","chainId":8453,"symbol":"USDC","decimals":6,"name":"USD Coin","coinKey":"USDC","logoURI":"https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48/logo.png","priceUSD":"0.999914","tags":["stablecoin"]},"amount":"1250","amountUSD":"0.0012","percentage":"0.0125","included":true}],"gasCosts":[{"type":"SEND","price":"5129610","estimate":"574111","limit":"1146344","amount":"2944965526710","amountUSD":"0.0061","token":{"address":"0x0000000000000000000000000000000000000000","chainId":8453,"symbol":"ETH","decimals":18,"name":"ETH","coinKey":"ETH","logoURI":"https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2/logo.png","priceUSD":"2078.35","tags":[]}}],"executionDuration":0,"fromAmountUSD":"0.1000","toAmountUSD":"0.0848"},"includedSteps":[{"id":"6238c375-d529-4228-ada7-f66ae38f9d11","type":"protocol","action":{"fromChainId":8453,"fromAmount":"100000","fromToken":{"address":"0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913","chainId":8453,"symbol":"USDC","decimals":6,"name":"USD Coin","coinKey":"USDC","logoURI":"https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48/logo.png","priceUSD":"0.999914","tags":["stablecoin"]},"toChainId":8453,"toToken":{"address":"0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913","chainId":8453,"symbol":"USDC","decimals":6,"name":"USD Coin","coinKey":"USDC","logoURI":"https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48/logo.png","priceUSD":"0.999914","tags":["stablecoin"]},"fromAddress":"0x1231DEB6f5749EF6cE6943a275A1D3E7486F4EaE","toAddress":"0x1231DEB6f5749EF6cE6943a275A1D3E7486F4EaE","jitoBundle":false},"estimate":{"fromAmount":"100000","toAmount":"98750","toAmountMin":"98750","tool":"feeCollection","approvalAddress":"0x0A6d96E7f4D7b96CFE42185DF61E64d255c12DFf","gasCosts":[{"type":"SEND","price":"5129610","estimate":"130000","limit":"569000","amount":"666849300000","amountUSD":"0.0014","token":{"address":"0x0000000000000000000000000000000000000000","chainId":8453,"symbol":"ETH","decimals":18,"name":"ETH","coinKey":"ETH","logoURI":"https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2/logo.png","priceUSD":"2078.35","tags":[]}}],"feeCosts":[{"name":"LIFI Fixed Fee","description":"Fixed LIFI fee, independent of any other fee","token":{"address":"0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913","chainId":8453,"symbol":"USDC","decimals":6,"name":"USD Coin","coinKey":"USDC","logoURI":"https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48/logo.png","priceUSD":"0.999914","tags":["stablecoin"]},"amount":"1250","amountUSD":"0.0012","percentage":"0.0125","included":true}],"executionDuration":0},"tool":"feeCollection","toolDetails":{"key":"feeCollection","name":"Integrator Fee","logoURI":"https://raw.githubusercontent.com/lifinance/types/main/src/assets/icons/protocols/feeCollection.svg"}},{"id":"d90c2194-3d3d-42e8-8fe3-2d6b86e76900","type":"swap","action":{"fromChainId":8453,"fromAmount":"98750","fromToken":{"address":"0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913","chainId":8453,"symbol":"USDC","decimals":6,"name":"USD Coin","coinKey":"USDC","logoURI":"https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48/logo.png","priceUSD":"0.999914","tags":["stablecoin"]},"toChainId":8453,"toToken":{"address":"0x9f86dB9fc6f7c9408e8Fda3Ff8ce4e78ac7a6b07","chainId":8453,"symbol":"CLAWD","decimals":18,"name":"clawd.atg.eth","priceUSD":"0.00007144","tags":[]},"fromAddress":"0x1231DEB6f5749EF6cE6943a275A1D3E7486F4EaE","toAddress":"0x1231DEB6f5749EF6cE6943a275A1D3E7486F4EaE","jitoBundle":false},"estimate":{"tool":"sushiswap","fromAmount":"98750","toAmount":"1186381027917016334336","toAmountMin":"1180449122777431252664","approvalAddress":"0xac4c6e212a361c968f1725b4d055b47e63f80b75","executionDuration":0,"feeCosts":[],"gasCosts":[{"type":"SEND","price":"5129610","estimate":"101111","limit":"531444","amount":"518659996710","amountUSD":"0.0011","token":{"address":"0x0000000000000000000000000000000000000000","chainId":8453,"symbol":"ETH","decimals":18,"name":"ETH","coinKey":"ETH","logoURI":"https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2/logo.png","priceUSD":"2078.35","tags":[]}}]},"tool":"sushiswap","toolDetails":{"key":"sushiswap","name":"SushiSwap Aggregator","logoURI":"https://raw.githubusercontent.com/lifinance/types/main/src/assets/icons/exchanges/sushi.svg"}}],"integrator":"Vibe-Team-Trading","executionType":"transaction","execution":{"status":"DONE","process":[{"type":"TOKEN_ALLOWANCE","startedAt":1770445770379,"message":"Token allowance set","status":"DONE","chainId":8453,"actionRequiredAt":1770445775954,"doneAt":1770445775961,"signedTypedData":[{"primaryType":"Permit","domain":{"name":"USD Coin","version":"2","chainId":8453,"verifyingContract":"0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913"},"types":{"Permit":[{"name":"owner","type":"address"},{"name":"spender","type":"address"},{"name":"value","type":"uint256"},{"name":"nonce","type":"uint256"},{"name":"deadline","type":"uint256"}]},"message":{"owner":"0xB418506A0dd0E6c81B2a2901a8aa2B6F409BFB3f","spender":"0x89c6340B1a1f4b25D36cd8B063D49045caF3f818","value":"100000","nonce":"1","deadline":"1770447575"},"signature":"0xe439b5e6bc8541c00a30f8dd464b0837d05a8b3428c43dc5d6622cd64198eabf4fdf3e67309e5b2436768bedcc53e89c2d64ba7bf48221971dcdb4b9a25e72d51c"}]},{"type":"SWAP","startedAt":1770445775963,"message":"Swap completed","status":"DONE","chainId":8453,"actionRequiredAt":1770445776986,"pendingAt":1770445783740,"txHash":"0x06e40c203fb9e06dd527c3901df15079029defca6ec241b36e85f121c9e74e7a","txType":"standard","txLink":"https://basescan.org/tx/0x06e40c203fb9e06dd527c3901df15079029defca6ec241b36e85f121c9e74e7a","doneAt":1770445784493,"substatus":"COMPLETED","substatusMessage":"The transfer is complete."}],"startedAt":1770445768363,"doneAt":1770445784495,"fromAmount":"100000","toAmount":"1186381027917016334336","toToken":{"address":"0x9f86dB9fc6f7c9408e8Fda3Ff8ce4e78ac7a6b07","chainId":8453,"symbol":"CLAWD","decimals":18,"name":"clawd.atg.eth","priceUSD":"0.00007144","tags":[]},"internalTxLink":"https://scan.li.fi/tx/0x06e40c203fb9e06dd527c3901df15079029defca6ec241b36e85f121c9e74e7a","gasCosts":[{"amount":"2535083982948","amountUSD":"0.0053","token":{"address":"0x0000000000000000000000000000000000000000","chainId":8453,"symbol":"ETH","decimals":18,"name":"ETH","coinKey":"ETH","logoURI":"https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2/logo.png","priceUSD":"2078.35","tags":[]},"estimate":"435732","limit":"435732","price":"5817989","type":"SEND"}]},"transactionRequest":{"value":"0x0","to":"0x1231DEB6f5749EF6cE6943a275A1D3E7486F4EaE","data":"0x5fd9ae2ef46d5730bcd6602f1066f15b14996c6c65738c2a3aa11ebeeadf5ecb0331e53900000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000100000000000000000000000000b418506a0dd0e6c81b2a2901a8aa2b6f409bfb3f00000000000000000000000000000000000000000000003ffe05bee0ea439eb800000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000011566962652d5465616d2d54726164696e67000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002a307830303030303030303030303030303030303030303030303030303030303030303030303030303030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000a6d96e7f4d7b96cfe42185df61e64d255c12dff0000000000000000000000000a6d96e7f4d7b96cfe42185df61e64d255c12dff000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda02913000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda0291300000000000000000000000000000000000000000000000000000000000186a000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000084eedd56e1000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda0291300000000000000000000000000000000000000000000000000000000000003e800000000000000000000000000000000000000000000000000000000000000fa0000000000000000000000004306d7a79265d2cb85db0c5a55ea5f4f6f73c4b100000000000000000000000000000000000000000000000000000000000000000000000000000000ac4c6e212a361c968f1725b4d055b47e63f80b75000000000000000000000000ac4c6e212a361c968f1725b4d055b47e63f80b75000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda029130000000000000000000000009f86db9fc6f7c9408e8fda3ff8ce4e78ac7a6b0700000000000000000000000000000000000000000000000000000000000181be00000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003445f3bd1c8000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda0291300000000000000000000000000000000000000000000000000000000000181be0000000000000000000000001231deb6f5749ef6ce6943a275a1d3e7486f4eae0000000000000000000000009f86db9fc6f7c9408e8fda3ff8ce4e78ac7a6b0700000000000000000000000000000000000000000000003ffe05bee0ea439eb8000000000000000000000000e89aab725a2b2c0656248dcccc894a04661be55a00000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000002246be92b89000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda0291300000000000000000000000000000000000000000000000000000000000181be0000000000000000000000009f86db9fc6f7c9408e8fda3ff8ce4e78ac7a6b0700000000000000000000000000000000000000000000004050581b2ca88c00000000000000000000000000001231deb6f5749ef6ce6943a275a1d3e7486f4eae00000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000e7019c36caa758000201833589fcd6edb6e08f4c7c32d4f71b54bda0291301ffff06498581ff718922c3f8e6a244956af099b2652b2b4200000000000000000000000000000000000006000001f400000a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e89aab725a2b2c0656248dcccc894a04661be55ac0df01ac801e01420000000000000000000000000000000000000601ffff01cd55381a53da35ab1d7bc5e3fe5f76cac976fac301e89aab725a2b2c0656248dcccc894a04661be55a00ac801e80a137000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000","chainId":8453,"gasPrice":"0x4e458a","gasLimit":"0x117de8","from":"0xB418506A0dd0E6c81B2a2901a8aa2B6F409BFB3f"},"transactionId":"0xf46d5730bcd6602f1066f15b14996c6c65738c2a3aa11ebeeadf5ecb0331e539"}],"tags":["RECOMMENDED","CHEAPEST","FASTEST"]}`;
      message = await getMessageWithEntryTradeStatus(
        group,
        content,
        extraLifiExecuteRouteResponse,
      );
    }
    if (category === "exit_trade_status") {
      const content = [
        "Target hit üéØ",
        "I've sold the 0.36 ENS for 2.59 USDC, securing a total profit of 0.59 USDC",
        "To complete the cycle, please sign the Yellow message to allow me to deposit the 2.59 USDC back into the Yellow app session",
      ].join("\n\n");
      const extraLifiExecuteRouteResponse = `{"id":"ea7bbd39-9da7-4cdd-838c-708d5e1e5777","fromChainId":8453,"fromAmountUSD":"0.1000","fromAmount":"100000","fromToken":{"address":"0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913","chainId":8453,"symbol":"USDC","decimals":6,"name":"USD Coin","coinKey":"USDC","logoURI":"https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48/logo.png","priceUSD":"0.999914","tags":["stablecoin"]},"fromAddress":"0xB418506A0dd0E6c81B2a2901a8aa2B6F409BFB3f","toChainId":8453,"toAmountUSD":"0.0848","toAmount":"1187519783431776763904","toAmountMin":"1181582184514617880084","toToken":{"address":"0x9f86dB9fc6f7c9408e8Fda3Ff8ce4e78ac7a6b07","chainId":8453,"symbol":"CLAWD","decimals":18,"name":"clawd.atg.eth","priceUSD":"0.00007144","tags":[]},"toAddress":"0xB418506A0dd0E6c81B2a2901a8aa2B6F409BFB3f","gasCostUSD":"0.0025","containsSwitchChain":false,"steps":[{"type":"lifi","id":"ea7bbd39-9da7-4cdd-838c-708d5e1e5777:0","tool":"sushiswap","toolDetails":{"key":"sushiswap","name":"SushiSwap Aggregator","logoURI":"https://raw.githubusercontent.com/lifinance/types/main/src/assets/icons/exchanges/sushi.svg"},"action":{"fromToken":{"address":"0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913","chainId":8453,"symbol":"USDC","decimals":6,"name":"USD Coin","coinKey":"USDC","logoURI":"https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48/logo.png","priceUSD":"0.999914","tags":["stablecoin"]},"fromAmount":"100000","toToken":{"address":"0x9f86dB9fc6f7c9408e8Fda3Ff8ce4e78ac7a6b07","chainId":8453,"symbol":"CLAWD","decimals":18,"name":"clawd.atg.eth","priceUSD":"0.00007144","tags":[]},"fromChainId":8453,"toChainId":8453,"slippage":0.005,"fromAddress":"0xB418506A0dd0E6c81B2a2901a8aa2B6F409BFB3f","toAddress":"0xB418506A0dd0E6c81B2a2901a8aa2B6F409BFB3f"},"estimate":{"tool":"sushiswap","approvalAddress":"0x1231DEB6f5749EF6cE6943a275A1D3E7486F4EaE","toAmountMin":"1180449122777431252664","toAmount":"1186381027917016334336","fromAmount":"100000","feeCosts":[{"name":"LIFI Fixed Fee","description":"Fixed LIFI fee, independent of any other fee","token":{"address":"0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913","chainId":8453,"symbol":"USDC","decimals":6,"name":"USD Coin","coinKey":"USDC","logoURI":"https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48/logo.png","priceUSD":"0.999914","tags":["stablecoin"]},"amount":"1250","amountUSD":"0.0012","percentage":"0.0125","included":true}],"gasCosts":[{"type":"SEND","price":"5129610","estimate":"574111","limit":"1146344","amount":"2944965526710","amountUSD":"0.0061","token":{"address":"0x0000000000000000000000000000000000000000","chainId":8453,"symbol":"ETH","decimals":18,"name":"ETH","coinKey":"ETH","logoURI":"https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2/logo.png","priceUSD":"2078.35","tags":[]}}],"executionDuration":0,"fromAmountUSD":"0.1000","toAmountUSD":"0.0848"},"includedSteps":[{"id":"6238c375-d529-4228-ada7-f66ae38f9d11","type":"protocol","action":{"fromChainId":8453,"fromAmount":"100000","fromToken":{"address":"0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913","chainId":8453,"symbol":"USDC","decimals":6,"name":"USD Coin","coinKey":"USDC","logoURI":"https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48/logo.png","priceUSD":"0.999914","tags":["stablecoin"]},"toChainId":8453,"toToken":{"address":"0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913","chainId":8453,"symbol":"USDC","decimals":6,"name":"USD Coin","coinKey":"USDC","logoURI":"https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48/logo.png","priceUSD":"0.999914","tags":["stablecoin"]},"fromAddress":"0x1231DEB6f5749EF6cE6943a275A1D3E7486F4EaE","toAddress":"0x1231DEB6f5749EF6cE6943a275A1D3E7486F4EaE","jitoBundle":false},"estimate":{"fromAmount":"100000","toAmount":"98750","toAmountMin":"98750","tool":"feeCollection","approvalAddress":"0x0A6d96E7f4D7b96CFE42185DF61E64d255c12DFf","gasCosts":[{"type":"SEND","price":"5129610","estimate":"130000","limit":"569000","amount":"666849300000","amountUSD":"0.0014","token":{"address":"0x0000000000000000000000000000000000000000","chainId":8453,"symbol":"ETH","decimals":18,"name":"ETH","coinKey":"ETH","logoURI":"https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2/logo.png","priceUSD":"2078.35","tags":[]}}],"feeCosts":[{"name":"LIFI Fixed Fee","description":"Fixed LIFI fee, independent of any other fee","token":{"address":"0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913","chainId":8453,"symbol":"USDC","decimals":6,"name":"USD Coin","coinKey":"USDC","logoURI":"https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48/logo.png","priceUSD":"0.999914","tags":["stablecoin"]},"amount":"1250","amountUSD":"0.0012","percentage":"0.0125","included":true}],"executionDuration":0},"tool":"feeCollection","toolDetails":{"key":"feeCollection","name":"Integrator Fee","logoURI":"https://raw.githubusercontent.com/lifinance/types/main/src/assets/icons/protocols/feeCollection.svg"}},{"id":"d90c2194-3d3d-42e8-8fe3-2d6b86e76900","type":"swap","action":{"fromChainId":8453,"fromAmount":"98750","fromToken":{"address":"0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913","chainId":8453,"symbol":"USDC","decimals":6,"name":"USD Coin","coinKey":"USDC","logoURI":"https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48/logo.png","priceUSD":"0.999914","tags":["stablecoin"]},"toChainId":8453,"toToken":{"address":"0x9f86dB9fc6f7c9408e8Fda3Ff8ce4e78ac7a6b07","chainId":8453,"symbol":"CLAWD","decimals":18,"name":"clawd.atg.eth","priceUSD":"0.00007144","tags":[]},"fromAddress":"0x1231DEB6f5749EF6cE6943a275A1D3E7486F4EaE","toAddress":"0x1231DEB6f5749EF6cE6943a275A1D3E7486F4EaE","jitoBundle":false},"estimate":{"tool":"sushiswap","fromAmount":"98750","toAmount":"1186381027917016334336","toAmountMin":"1180449122777431252664","approvalAddress":"0xac4c6e212a361c968f1725b4d055b47e63f80b75","executionDuration":0,"feeCosts":[],"gasCosts":[{"type":"SEND","price":"5129610","estimate":"101111","limit":"531444","amount":"518659996710","amountUSD":"0.0011","token":{"address":"0x0000000000000000000000000000000000000000","chainId":8453,"symbol":"ETH","decimals":18,"name":"ETH","coinKey":"ETH","logoURI":"https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2/logo.png","priceUSD":"2078.35","tags":[]}}]},"tool":"sushiswap","toolDetails":{"key":"sushiswap","name":"SushiSwap Aggregator","logoURI":"https://raw.githubusercontent.com/lifinance/types/main/src/assets/icons/exchanges/sushi.svg"}}],"integrator":"Vibe-Team-Trading","executionType":"transaction","execution":{"status":"DONE","process":[{"type":"TOKEN_ALLOWANCE","startedAt":1770445770379,"message":"Token allowance set","status":"DONE","chainId":8453,"actionRequiredAt":1770445775954,"doneAt":1770445775961,"signedTypedData":[{"primaryType":"Permit","domain":{"name":"USD Coin","version":"2","chainId":8453,"verifyingContract":"0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913"},"types":{"Permit":[{"name":"owner","type":"address"},{"name":"spender","type":"address"},{"name":"value","type":"uint256"},{"name":"nonce","type":"uint256"},{"name":"deadline","type":"uint256"}]},"message":{"owner":"0xB418506A0dd0E6c81B2a2901a8aa2B6F409BFB3f","spender":"0x89c6340B1a1f4b25D36cd8B063D49045caF3f818","value":"100000","nonce":"1","deadline":"1770447575"},"signature":"0xe439b5e6bc8541c00a30f8dd464b0837d05a8b3428c43dc5d6622cd64198eabf4fdf3e67309e5b2436768bedcc53e89c2d64ba7bf48221971dcdb4b9a25e72d51c"}]},{"type":"SWAP","startedAt":1770445775963,"message":"Swap completed","status":"DONE","chainId":8453,"actionRequiredAt":1770445776986,"pendingAt":1770445783740,"txHash":"0x06e40c203fb9e06dd527c3901df15079029defca6ec241b36e85f121c9e74e7a","txType":"standard","txLink":"https://basescan.org/tx/0x06e40c203fb9e06dd527c3901df15079029defca6ec241b36e85f121c9e74e7a","doneAt":1770445784493,"substatus":"COMPLETED","substatusMessage":"The transfer is complete."}],"startedAt":1770445768363,"doneAt":1770445784495,"fromAmount":"100000","toAmount":"1186381027917016334336","toToken":{"address":"0x9f86dB9fc6f7c9408e8Fda3Ff8ce4e78ac7a6b07","chainId":8453,"symbol":"CLAWD","decimals":18,"name":"clawd.atg.eth","priceUSD":"0.00007144","tags":[]},"internalTxLink":"https://scan.li.fi/tx/0x06e40c203fb9e06dd527c3901df15079029defca6ec241b36e85f121c9e74e7a","gasCosts":[{"amount":"2535083982948","amountUSD":"0.0053","token":{"address":"0x0000000000000000000000000000000000000000","chainId":8453,"symbol":"ETH","decimals":18,"name":"ETH","coinKey":"ETH","logoURI":"https://raw.githubusercontent.com/trustwallet/assets/master/blockchains/ethereum/assets/0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2/logo.png","priceUSD":"2078.35","tags":[]},"estimate":"435732","limit":"435732","price":"5817989","type":"SEND"}]},"transactionRequest":{"value":"0x0","to":"0x1231DEB6f5749EF6cE6943a275A1D3E7486F4EaE","data":"0x5fd9ae2ef46d5730bcd6602f1066f15b14996c6c65738c2a3aa11ebeeadf5ecb0331e53900000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000100000000000000000000000000b418506a0dd0e6c81b2a2901a8aa2b6f409bfb3f00000000000000000000000000000000000000000000003ffe05bee0ea439eb800000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000011566962652d5465616d2d54726164696e67000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002a307830303030303030303030303030303030303030303030303030303030303030303030303030303030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000a6d96e7f4d7b96cfe42185df61e64d255c12dff0000000000000000000000000a6d96e7f4d7b96cfe42185df61e64d255c12dff000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda02913000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda0291300000000000000000000000000000000000000000000000000000000000186a000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000084eedd56e1000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda0291300000000000000000000000000000000000000000000000000000000000003e800000000000000000000000000000000000000000000000000000000000000fa0000000000000000000000004306d7a79265d2cb85db0c5a55ea5f4f6f73c4b100000000000000000000000000000000000000000000000000000000000000000000000000000000ac4c6e212a361c968f1725b4d055b47e63f80b75000000000000000000000000ac4c6e212a361c968f1725b4d055b47e63f80b75000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda029130000000000000000000000009f86db9fc6f7c9408e8fda3ff8ce4e78ac7a6b0700000000000000000000000000000000000000000000000000000000000181be00000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003445f3bd1c8000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda0291300000000000000000000000000000000000000000000000000000000000181be0000000000000000000000001231deb6f5749ef6ce6943a275a1d3e7486f4eae0000000000000000000000009f86db9fc6f7c9408e8fda3ff8ce4e78ac7a6b0700000000000000000000000000000000000000000000003ffe05bee0ea439eb8000000000000000000000000e89aab725a2b2c0656248dcccc894a04661be55a00000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000002246be92b89000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda0291300000000000000000000000000000000000000000000000000000000000181be0000000000000000000000009f86db9fc6f7c9408e8fda3ff8ce4e78ac7a6b0700000000000000000000000000000000000000000000004050581b2ca88c00000000000000000000000000001231deb6f5749ef6ce6943a275a1d3e7486f4eae00000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000e7019c36caa758000201833589fcd6edb6e08f4c7c32d4f71b54bda0291301ffff06498581ff718922c3f8e6a244956af099b2652b2b4200000000000000000000000000000000000006000001f400000a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e89aab725a2b2c0656248dcccc894a04661be55ac0df01ac801e01420000000000000000000000000000000000000601ffff01cd55381a53da35ab1d7bc5e3fe5f76cac976fac301e89aab725a2b2c0656248dcccc894a04661be55a00ac801e80a137000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000","chainId":8453,"gasPrice":"0x4e458a","gasLimit":"0x117de8","from":"0xB418506A0dd0E6c81B2a2901a8aa2B6F409BFB3f"},"transactionId":"0xf46d5730bcd6602f1066f15b14996c6c65738c2a3aa11ebeeadf5ecb0331e539"}],"tags":["RECOMMENDED","CHEAPEST","FASTEST"]}`;
      message = await getMessageWithExitTradeStatus(
        group,
        content,
        extraLifiExecuteRouteResponse,
      );
    }
    if (category === "distribute_request") {
      const content = [
        "2.59 USDC is ready for payout üí∞",
        "Please sign this final Yellow message to authorize the distribution of the funds back to your individual balances, returning your initial stake plus the shared profit",
      ].join("\n\n");
      message = await getMessageWithDistributeRequest(group, content);
    }
    if (category === "distribute_status") {
      const content = "Distribution complete üëå";
      message = await getMessageWithDistributeStatus(group, content);
    }

    // Add message to the group and save to database
    if (message) {
      group.messages.push(message);
      await insertOrUpdateGroup(group);
    }

    return createSuccessApiResponse({ group });
  } catch (error) {
    console.error(
      `[API] Failed to create demo message, error: ${getErrorString(error)}`,
    );
    return createFailedApiResponse(
      { message: "Internal server error, try again later" },
      500,
    );
  }
}
